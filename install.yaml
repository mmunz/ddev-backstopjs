name: ddev-backstopjs

pre_install_actions:
  - test -d ${DDEV_APPROOT}/tests/backstop || mkdir -p ${DDEV_APPROOT}/tests/backstop
  - test -f "${DDEV_APPROOT}/tests/backstop/.gitignore" || printf "## ddev-generated\n**/bitmaps_test\n**/html_report\n" > ${DDEV_APPROOT}/tests/backstop/.gitignore
  - grep -q "## ddev-generated" ${DDEV_APPROOT}/tests/backstop/.gitignore && printf "## ddev-generated\n**/bitmaps_test\n**/html_report\n" > ${DDEV_APPROOT}/tests/backstop/.gitignore || true


# list of files and directories listed that are copied into project .ddev directory
# Each file should contain #ddev-generated so it can be replaced by a later `ddev get`
# if it hasn't been modified by the user.
# DDEV environment variables can be interpolated into these filenames
project_files:
- docker-compose.backstop.yaml
- backstopBuild/
- commands/backstop/backstop
- commands/host/backstop-results

post_install_actions:
 - |
    #ddev-nodisplay
    #ddev-description:Checking docker-compose.backstop_extras.yaml for changes
    if [ -f docker-compose.backstop_extras.yaml ] && ! grep -q '#ddev-generated' docker-compose.backstop_extras.yaml; then
      echo "Existing docker-compose.backstop_extras.yaml does not have #ddev-generated, so can't be updated"
      exit 2
    fi
 - |
    #ddev-nodisplay
    #ddev-description:Adding all hostnames to the backstop container to make them available
    cat <<-END >docker-compose.backstop_extras.yaml
    #ddev-generated
    services:
      backstop:
        external_links:
        {{- $backstop_hostnames := splitList "," (env "DDEV_HOSTNAME") -}}
        {{- range $i, $n := $backstop_hostnames }}
          - "ddev-router:{{- replace (env "DDEV_TLD") "\\${DDEV_TLD}" (replace (env "DDEV_PROJECT") "\\${DDEV_PROJECT}" $n) -}}"
        {{- end }}
    END
 - echo "Install finished. Please restart ddev with 'ddev restart'"
 - echo "After that create your backstop config, e.g. run ddev backstop init."

removal_actions:
  - |
    #ddev-nodisplay
    #ddev-description:Remove docker-compose.backstop_extras.yaml file
    if [ -f docker-compose.backstop_extras.yaml ]; then
      if grep -q '#ddev-generated' docker-compose.backstop_extras.yaml; then
        rm -f docker-compose.backstop_extras.yaml
      else
        echo "Unwilling to remove '$DDEV_APPROOT/.ddev/docker-compose.backstop_extras.yaml' because it does not have #ddev-generated in it; you can manually delete it if it is safe to delete."
      fi
    fi